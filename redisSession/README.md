# NextJs(Client) <-> SpringBoots(Servers)   [width Redis Session]

```properties
# âœ… Redis Session Clusteringë¥¼ ì‚¬ìš©í•´ì„œ MAS êµ¬ì¡°ì—ì„œë„ Sessionì„ ê³µìœ 

# ğŸ—¨ ë¶„ì„  ì„œë²„ êµ¬ì¡°ì—ì„œ SessionID ì „ë‹¬ ë°©ì‹
#  â—½ ë°©ë²• 1 -  Cookieì— Session ID ì „ë‹¬
#  â—½ ë°©ë²• 2 -  Custom Headerì— Session ID ì „ë‹¬
```

## Session ID ì „ë‹¬ ë°©ì‹ ë¹„êµ

| **ë°©ì‹**                     | **ì¥ì **                                                                                      | **ë‹¨ì **                                                   |
|------------------------------|-----------------------------------------------------------------------------------------------|----------------------------------------------------------|
| **Cookieì— Session ID**         | - ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ê´€ë¦¬ (ì¿ í‚¤ ìë™ ì „ì†¡)                                                   | - CSRF ê³µê²©ì— ì·¨ì•½ (ì¶”ê°€ì ìœ¼ë¡œ CSRF í† í° í•„ìš”)                         |
|                              | - `SameSite`, `HttpOnly`, `Secure` ì†ì„±ìœ¼ë¡œ ì¶”ê°€ ë³´ì•ˆ ì„¤ì • ê°€ëŠ¥                                | - ë¸Œë¼ìš°ì € ì œì•½ì´ë‚˜ CORS ì„¤ì •ì— ì˜í•´ ì¿ í‚¤ ì „ì†¡ì´ ì°¨ë‹¨ë  ìˆ˜ ìˆìŒ                  |
|                              | - ë³„ë„ì˜ í´ë¼ì´ì–¸íŠ¸ ë¡œì§ ì—†ì´ ë¸Œë¼ìš°ì €ê°€ ì²˜ë¦¬                                                 | - ë¹„ ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ì›€ ( **ì¥ì ì´ ë  ìˆ˜ ìˆìŒ!** )               |
| **Custom Headerì— Session ID**| - CSRF ê³µê²© ë°©ì–´ ê°€ëŠ¥                                       | - í´ë¼ì´ì–¸íŠ¸ì—ì„œ ëª¨ë“  ìš”ì²­ë§ˆë‹¤ Session IDë¥¼ ì„¤ì •í•´ì•¼ í•¨     |
|                              | - ë¸Œë¼ìš°ì € ì™¸ì˜ í™˜ê²½(ëª¨ë°”ì¼ ì•±, ì„œë²„ ê°„ í†µì‹  ë“±)ì—ì„œë„ ì‰½ê²Œ ì‚¬ìš© ê°€ëŠ¥                           | - ì¿ í‚¤ì— ë¹„í•´ êµ¬í˜„ ë³µì¡ë„ ì¦ê°€ (í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì—ì„œ ê´€ë¦¬ í•„ìš”)                    |
|                              | - ì¿ í‚¤ ê´€ë ¨ ë¸Œë¼ìš°ì € ì •ì±…ì— êµ¬ì• ë°›ì§€ ì•ŠìŒ (SameSite, CORS ë¬¸ì œ ì—†ìŒ)                          | - í—¤ë”ì— Session IDê°€ ë‹´ê¸¸ ê²½ìš°, HTTPS ë¯¸ì‚¬ìš© ì‹œ ë³´ì•ˆì— ì·¨ì•½  |


## íë¦„

![alt text](image.png)


## ê³µí†µ Server ì„¤ì •

- ### Dependencies ì¶”ê°€
```groovy
dependencies {
	implementation 'org.springframework.boot:spring-boot-starter-data-redis'
	implementation 'org.springframework.session:spring-session-data-redis'
}
```

- ### application ì„¤ì •
  - `namespace`ë¥¼ ì‚¬ìš©í•´ì„œ Redisì— ì €ì¥ë  Session Key ê°’ ì§€ì •
  - `store-type` ì§€ì •ì„ í†µí•´ Sessionì„ Redisì— ì €ì¥í•  ê²ƒì„ ì•Œë¦¼
```properties
spring:
  session:
    store-type: redis
    redis:
      # Redisì— ì €ì¥ë  Key Prefix
      namespace: yoo:session

  ############################
  ## Redis Setting
  # docker run -d --name security-redies-db -p 6379:6379 redis --requirepass "123"
  ############################
  data:
    redis:
      host: localhost
      port: 6379
      password: 123
```

## Cookie ì „ë‹¬ ë°©ì‹ Server ì„¤ì •

- ### Cookie ì„¤ì •
  - ì£¼ì˜ì‚¬í•­
    - Redis Session ì‚¬ìš© ì‹œ ê¸°ë³¸ ì„¤ì • Session Keyê°’ì´ `SESSION`ìœ¼ë¡œ ë³€ê²½ë¨ì—ë”°ë¼ ì¶”ê°€ì ì¸ ë³€ê²½ ì„¤ì •ì´ í•„ìš”
      - `serializer.setCookieName("JSESSIONID");`
    - ğŸ›‘ **ì‚½ì§ˆ**`setSameSite` ì„¤ì • ì£¼ì˜ `None`ìœ¼ë¡œ ì„¤ì •í•  ê²½ìš° Session ID ê°’ì„ Client -> Server ì „ë‹¬ ë°›ì§€ ëª»í•¨
      - Chromeì˜ ê²½ìš° ë³´ì•ˆì„ ìœ„í•´  ìì²´ì ìœ¼ë¡œ ë§‰ìŒ
      - `None`ì„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ `setUseSecureCookie(true)`ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨
      
### SameSite ì†ì„± ìš”ì•½

- **SameSite=Lax**:
  - ë™ì¼í•œ ì‚¬ì´íŠ¸ ë‚´ì—ì„œë§Œ ì¿ í‚¤ê°€ ì „ì†¡ë˜ë©°, ì™¸ë¶€ ë§í¬ì—ì„œ ë„˜ì–´ì˜¨ ê²½ìš°ì—ë„ **GET ìš”ì²­**ì— í•œí•´ì„œë§Œ ì¿ í‚¤ê°€ ì „ì†¡
  - **ê¸°ë³¸ ì„¤ì •**ì´ë©°, ë³´ì•ˆê³¼ ì‚¬ìš© í¸ì˜ì„± ê°„ì˜ ê· í˜•ì„ ìœ ì§€
  - **ì˜ˆì‹œ**: ì‚¬ìš©ìê°€ ì‚¬ì´íŠ¸ Aì—ì„œ ë§í¬ë¥¼ í´ë¦­í•˜ì—¬ ì‚¬ì´íŠ¸ Bë¡œ ì´ë™í•˜ëŠ” ê²½ìš°, ì‚¬ì´íŠ¸ Bì—ì„œì˜ **GET ìš”ì²­** ì‹œ ì¿ í‚¤ê°€ ì „ì†¡ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì‚¬ì´íŠ¸ Aì—ì„œì˜ **POST ìš”ì²­** ì‹œ **ì¿ í‚¤ ì „ì†¡X**

- **SameSite=Strict**:
  - **ë‹¤ë¥¸ ë„ë©”ì¸**ì—ì„œì˜ ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ **ì¿ í‚¤ê°€ ì „ì†¡ë˜ì§€ ì•ŠìŒ**
  - ì™¸ë¶€ ë§í¬ë‚˜ POST ìš”ì²­ì´ ìˆì„ ë•Œ ì¿ í‚¤ê°€ ì°¨ë‹¨ë  ìˆ˜ ìˆì–´ ì—„ê²©í•œ ë³´ì•ˆì„ ì œê³µ
  - **ì˜ˆì‹œ**: ì‚¬ìš©ìê°€ ì‚¬ì´íŠ¸ Aì—ì„œ ë§í¬ë¥¼ í´ë¦­í•˜ì—¬ ì‚¬ì´íŠ¸ Bë¡œ ì´ë™í•˜ë©´, ì‚¬ì´íŠ¸ Bì—ì„œì˜ **ëª¨ë“  ìš”ì²­**(GET, POST ë“±)ì— ëŒ€í•´ **ì¿ í‚¤ ì „ì†¡X**

- **SameSite=None**:
  - ëª¨ë“  ë„ë©”ì¸ì˜ ìš”ì²­ì— ëŒ€í•´ ì¿ í‚¤ê°€ ì „ì†¡ë˜ì§€ë§Œ ë³´ì•ˆì— êµ‰ì¥íˆ ì·¨ì•½
  - í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìš”ì²­ì— ëŒ€í•´ ì¿ í‚¤ê°€ í•„ìš”í•  ë•Œ ì‚¬ìš©

```java
@Configuration
public class CookieConfig {
  @Bean
  public CookieSerializer cookieSerializer() {
    DefaultCookieSerializer serializer = new DefaultCookieSerializer();
    /**
     * ğŸ˜” ë³´ì•ˆ ë¬¸ì œë¡œ ìƒê¸´ ì´ìŠˆ [ ì‚½ì§ˆ 3ì¼.. ]
     *
     *  ì›ì¸ : Redis ì„¸ì…˜ê³¼ ê¸°ë³¸ ì„¸ì…˜ ê°„ì˜ ì „ì†¡ ë°©ì‹ì˜ ì°¨ì´ë¡œ ì¸í•´ Secure ì†ì„±ì„ ì„¤ì •í•˜ì§€ ì•Šì€ ê²½ìš° ì¿ í‚¤ê°€ ìë™ìœ¼ë¡œ ì „ë‹¬ì´ ë§‰í˜
     *      - Redis ì„¸ì…˜ì€ ê¸°ë³¸ ì„¸ì…˜ê³¼ëŠ” ë‹¬ë¦¬ ì™¸ë¶€ ì €ì¥ì†Œì—ì„œ ì„¸ì…˜ ë°ì´í„°ë¥¼ ê´€ë¦¬í•¨ ë”°ë¼ì„œ ì•ˆì „í•˜ì§€ ì•Šì€ ì„¤ì •ì„ í†µí•´ ì¿ í‚¤ë¥¼ 
     *      ì‚¬ìš© ì„¸ì…˜ IDì˜ ì „ì†¡í•  ê²½ìš° ë¸Œë¼ìš°ì €ê°€ ì´ë¥¼ ì°¨ë‹¨ --> ì„œë²„ê°€ Redisì—ì„œ ì„¸ì…˜ì„ ì¡°íšŒí•  ìˆ˜ ì—†ê²Œ ë¨
     *
     * // serializer.setSameSite("None");
     *
     * */
    // HTTP í”„ë¡œí† ì½œì¼ ê²½ìš°ì—ë„ ì¿ í‚¤ ì „ì†¡ í—ˆìš© [ ë¹„ê¶Œì¥ ]
    serializer.setUseSecureCookie(false);
    // ì¿ í‚¤ê°€ ìœ íš¨í•œ ë„ë©”ì¸ì„ ì§€ì •
    serializer.setDomainName("localhost");
    return serializer;
  }
}
```
